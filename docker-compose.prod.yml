version: '3.8'

services:
  # 1. Flask API Service
  vr-recommender:
    build:
      context: .
      dockerfile: Dockerfile.prod
    image: vr-recommender:prod
    container_name: vr-recommender
    restart: always
    ports:
      - "5001:5000" # Map host 5001 to container 5000
    env_file:
      - .env
    environment:
      - PORT=5000
      # Neo4j connection - uses Docker service name (no auth)
      - NEO4J_URI=bolt://neo4j:7687
    volumes:
      - chroma_data:/app/vector_store/data/chroma  # ChromaDB persistence
    depends_on:
      - neo4j
    networks:
      - vr-net

  # 2. Neo4j (Graph Database)
  neo4j:
    image: neo4j:5.15.0
    container_name: vr-neo4j
    restart: always
    ports:
      - "7474:7474"
      - "7687:7687"
    environment:
      - NEO4J_AUTH=none
      - NEO4J_PLUGINS=["apoc", "graph-data-science"]
    volumes:
      - neo4j_data:/data
    networks:
      - vr-net

volumes:
  neo4j_data:
  chroma_data:  # ChromaDB vector store persistence

networks:
  vr-net:
    driver: bridge
