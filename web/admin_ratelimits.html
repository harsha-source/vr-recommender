<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VR Recommender - Rate Limits Configuration</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body { background-color: #f4f6f9; }
        .card { border: none; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .form-label { font-weight: 600; color: #34495e; }
        #auth-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.95); z-index: 9999;
            display: flex; align-items: center; justify-content: center;
        }
        .limit-input { font-family: monospace; }
        .example-text { font-size: 0.85rem; color: #6c757d; }
    </style>
</head>
<body>

<!-- Auth Overlay -->
<div id="auth-overlay">
    <div class="card shadow-lg p-4" style="width: 350px;">
        <h4 class="text-center mb-3"><i class="bi bi-shield-lock-fill text-primary"></i> Admin Login</h4>
        <div class="mb-3">
            <label class="form-label">Password</label>
            <input type="password" id="auth-pass" class="form-control" onkeyup="if(event.key==='Enter') doLogin()">
        </div>
        <button class="btn btn-primary w-100" onclick="doLogin()">Unlock</button>
        <p id="auth-error" class="text-danger mt-2 text-center small"></p>
    </div>
</div>

<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
        <a class="navbar-brand" href="/admin">
            <i class="bi bi-shield-lock me-2"></i>Heinz VR Admin
        </a>
        <div class="collapse navbar-collapse">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                <li class="nav-item">
                    <a class="nav-link" href="/admin">Logs & Stats</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/admin/data">Data Management</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/admin/config">System Config</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="/admin/ratelimits">Rate Limits</a>
                </li>
            </ul>
            <button class="btn btn-sm btn-danger" onclick="doLogout()">
                <i class="bi bi-box-arrow-right"></i> Logout
            </button>
        </div>
    </div>
</nav>

<div class="container mt-4">
    <h2 class="mb-4"><i class="bi bi-speedometer2 me-2"></i>Rate Limit Configuration</h2>

    <div class="alert alert-success">
        <i class="bi bi-lightning-charge me-2"></i>
        <strong>Hot Reload Enabled:</strong> Changes take effect immediately without restarting the server.
    </div>

    <div class="alert alert-info">
        <i class="bi bi-info-circle me-2"></i>
        <strong>Format:</strong> Use pattern like <code>N per minute</code>, <code>N per hour</code>, or <code>N per day</code>.
        Example: <code>10 per minute</code>
    </div>

    <div class="alert alert-secondary">
        <i class="bi bi-shield-check me-2"></i>
        <strong>Default Limits:</strong> All endpoints have base limits of <code>200 per day</code> and <code>50 per hour</code> per user (requires restart to change).
    </div>

    <form id="ratelimit-form" onsubmit="event.preventDefault(); saveRateLimits();">

        <!-- Endpoint-Specific Limits (Hot-Reload Capable) -->
        <div class="card">
            <div class="card-header bg-white text-warning">
                <h5 class="mb-0"><i class="bi bi-bullseye me-2"></i>Endpoint-Specific Limits (Hot-Reload)</h5>
            </div>
            <div class="card-body">

                <div class="mb-4">
                    <label class="form-label">
                        <i class="bi bi-chat-dots me-1"></i> Chat Endpoint <code>/chat</code>
                    </label>
                    <input type="text" class="form-control limit-input" name="RATE_LIMIT_CHAT" placeholder="10 per minute">
                    <div class="form-text">
                        Controls how many chat messages a user can send. Lower values protect LLM API costs.
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">
                        <i class="bi bi-key me-1"></i> Login Endpoint <code>/api/auth/login</code>
                    </label>
                    <input type="text" class="form-control limit-input" name="RATE_LIMIT_LOGIN" placeholder="5 per minute">
                    <div class="form-text">
                        Prevents brute-force password attacks. Keep this value low (5-10 per minute).
                    </div>
                </div>
            </div>
        </div>

        <div class="d-grid gap-2 d-md-flex justify-content-md-end mb-5">
            <button type="button" class="btn btn-light me-md-2" onclick="fetchRateLimits()">
                <i class="bi bi-arrow-counterclockwise me-1"></i>Reset
            </button>
            <button type="submit" class="btn btn-primary px-5">
                <i class="bi bi-check-lg me-1"></i>Save Changes
            </button>
        </div>
    </form>
</div>

<!-- Toast Container -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
    <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <strong class="me-auto" id="toast-title">Notification</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="toast-body">
            Action completed.
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // --- Auth Logic (same as other admin pages) ---
    async function checkAuth() {
        try {
            const res = await fetch('/api/auth/check');
            const data = await res.json();
            if (data.is_admin) {
                document.getElementById('auth-overlay').style.display = 'none';
                fetchRateLimits();
            } else {
                document.getElementById('auth-overlay').style.display = 'flex';
            }
        } catch (e) {
            console.error("Auth check failed", e);
            document.getElementById('auth-overlay').style.display = 'flex';
        }
    }

    async function doLogin() {
        const pass = document.getElementById('auth-pass').value;
        const err = document.getElementById('auth-error');

        try {
            const res = await fetch('/api/auth/login', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({password: pass})
            });

            const data = await res.json();

            if (res.ok) {
                location.reload();
            } else {
                err.textContent = data.error || 'Login failed';
            }
        } catch (e) {
            err.textContent = "Network error";
        }
    }

    async function doLogout() {
        await fetch('/api/auth/logout', {method: 'POST'});
        location.reload();
    }

    // --- Rate Limit Logic ---

    async function fetchRateLimits() {
        try {
            const res = await fetch('/api/admin/ratelimits');
            if (res.status === 401) return location.reload();

            const config = await res.json();
            populateForm(config);
        } catch (err) {
            console.error("Fetch rate limits error:", err);
            showToast("Error", "Failed to load rate limits", "text-danger");
        }
    }

    function populateForm(config) {
        const form = document.getElementById('ratelimit-form');

        for (const [key, data] of Object.entries(config)) {
            const input = form.elements[key];
            if (input) {
                input.value = data.value;
                input.placeholder = data.example || data.default;
            }
        }
    }

    async function saveRateLimits() {
        const form = document.getElementById('ratelimit-form');
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());

        // Button loading state
        const btn = form.querySelector('button[type="submit"]');
        const originalHTML = btn.innerHTML;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Saving...';
        btn.disabled = true;

        try {
            const res = await fetch('/api/admin/ratelimits', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });

            const result = await res.json();

            if (res.ok) {
                showToast("Success", result.message || "Rate limits saved!", "text-success");
            } else {
                const errorMsg = result.details ? result.details.join(', ') : (result.error || "Failed to save");
                showToast("Error", errorMsg, "text-danger");
            }
        } catch (err) {
            console.error("Save error:", err);
            showToast("Error", "Network error", "text-danger");
        } finally {
            btn.innerHTML = originalHTML;
            btn.disabled = false;
        }
    }

    function showToast(title, message, textClass="text-dark") {
        const toastEl = document.getElementById('liveToast');
        document.getElementById('toast-title').innerText = title;
        const body = document.getElementById('toast-body');
        body.innerText = message;
        body.className = "toast-body " + textClass;

        const toast = new bootstrap.Toast(toastEl);
        toast.show();
    }

    // Start
    checkAuth();
</script>

</body>
</html>
